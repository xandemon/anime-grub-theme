name: Generate Theme Variants and Release

on:
  push:
    branches: [main]
    paths:
      - 'base/**'
      - 'variants/**'
      - 'VERSION'
      - '.github/workflows/generate-themes.yml'
      - 'generate-themes.sh'
  workflow_dispatch:

jobs:
  generate-and-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Install zip
        run: sudo apt-get update && sudo apt-get install -y zip
      
      - name: Read version
        id: version
        run: |
          if [ -f VERSION ]; then
            VERSION=$(cat VERSION | tr -d '[:space:]')
          else
            VERSION=$(date +%Y.%m.%d-%H%M%S)
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag=v$VERSION" >> $GITHUB_OUTPUT
      
      - name: Generate themes
        run: chmod +x generate-themes.sh && ./generate-themes.sh
      
      - name: Create/update release
        run: |
          TAG="${{ steps.version.outputs.tag }}"
          VERSION="${{ steps.version.outputs.version }}"
          THEMES=$(ls releases/*.zip 2>/dev/null | sed 's|releases/||; s|\.zip||' | sed 's/^/- /' || echo "")
          
          NOTES="## Anime GRUB Theme v${VERSION}
          
          ### Available Themes
          ${THEMES}"
          
          if gh release view "$TAG" 2>/dev/null; then
            gh release delete-asset "$TAG" --pattern "*.zip" 2>/dev/null || true
            gh release edit "$TAG" --title "Anime GRUB Theme v${VERSION}" --notes "$NOTES"
          else
            gh release create "$TAG" --title "Anime GRUB Theme v${VERSION}" --notes "$NOTES"
          fi
          
          for zip_file in releases/*.zip; do
            gh release upload "$TAG" "$zip_file" --clobber
          done
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
